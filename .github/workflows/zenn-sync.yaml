name: Sync to Zenn

on:
  push:
    paths:
      - 'content/ja/**'  # Only trigger when Japanese content changes
      - 'scripts/sync_zenn.py' # Or when you update the script
      - 'static/images/**' # Or image updates
      - 'assets/**'
    branches:
      - main

permissions:
  contents: write # Required to push the generated files back

jobs:
  deploy-to-zenn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          pip install python-frontmatter toml

      # 1. Prepare the Output Directory
      # We create a clean folder 'zenn_dist' to hold exactly what Zenn needs.
      - name: Prepare Zenn Distribution
        run: |
          mkdir -p zenn_dist/articles
          mkdir -p zenn_dist/books
          mkdir -p zenn_dist/images

          # Copy essential Zenn config
          # (Ensure you have run 'npx zenn-cli init' once to get this file)
          cp zenn.json zenn_dist/

          # Copy images from Hugo's static folder to Zenn's images folder
          # Hugo: static/images/foo.png -> Zenn: images/foo.png
          if [ -d "static/images" ]; then
            cp -r static/images/* zenn_dist/images/
          fi

      # 2. Run your Python Script
      # *IMPORTANT*: Update your script to output to 'zenn_dist/articles'
      - name: Generate Articles
        run: |
          # Passing the output directory as an argument or updating the script
          # is cleaner, but for now we can just run it and move files if needed.
          # Assuming your script writes to 'articles/' in root:
          python scripts/sync_zenn.py

          # Move generated articles to the dist folder
          cp articles/*.md zenn_dist/articles/

      # 3. Deploy to the 'zenn-sync' branch
      - name: Deploy to Zenn Branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./zenn_dist
          publish_branch: zenn-sync  # The branch Zenn is now watching
          commit_message: "chore: sync content from main [skip ci]"

