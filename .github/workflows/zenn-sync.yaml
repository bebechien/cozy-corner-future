name: Publish to Zenn
on:
  push:
    paths:
      - 'content/ja/**'  # Only trigger when Japanese content changes
      - 'scripts/sync_zenn.py' # Or when you update the script
      - 'scripts/sync_utils.py'
      - 'static/images/**' # Or image updates
      - 'assets/**'
    branches:
      - main

permissions:
  contents: write # Required to push the generated files back

jobs:
  deploy-to-zenn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install python-frontmatter toml

      - name: Prepare Zenn Distribution
        run: |
          mkdir -p zenn_dist/articles
          mkdir -p zenn_dist/books
          mkdir -p zenn_dist/images

          touch zenn_dist/articles/.keep
          touch zenn_dist/books/.keep
          touch zenn_dist/images/.keep

          # Copy essential Zenn config
          # (Ensure you have run 'npx zenn-cli init' once to get this file)
          #cp zenn.json zenn_dist/

          # Copy images from Hugo's static folder to Zenn's images folder
          # Hugo: static/images/foo.png -> Zenn: images/foo.png
          #if [ -d "static/images" ]; then
          #  cp -r static/images/* zenn_dist/images/
          #fi

      - name: Prepare Content (Fix Images & Metadata)
        run: python scripts/sync_zenn.py

      - name: Deploy to Zenn Branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./zenn_dist
          publish_branch: zenn-sync
          commit_message: "chore: sync content from main [skip ci]"
